{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" type="text/css" href="./static/css/jsCalendar.css">
<link rel="stylesheet" type="text/css" href="./static/css/jsCalendar.micro.css">
<script type="text/javascript" src="./static/js/jsCalendar.js"></script>
<script type="text/javascript" src="./static/js/jsCalendar.datepicker.js"></script>
<link href="./static/css/styles3.css" rel="stylesheet" />

<style>
    html,
    body {
        font-family: "Century Gothic", CenturyGothic, AppleGothic, sans-serif;
    }

    .description {
        text-align: center;
        padding-bottom: 40px;
    }

    .jsCalendar.clean-theme tbody td.jsCalendar-previous,
    .jsCalendar.clean-theme tbody td.jsCalendar-next {
        color: #000;
        opacity: 0.2;
    }

    #wrapper {
        margin: 0 auto;
        width: 800px;
        box-shadow: 0px 0px 2px rgba(0, 0, 0, 0.4);
    }

    #wrapper .jsCalendar table {
        box-shadow: none;
    }

    .clear {
        clear: both;
    }

    #events-calendar {
        float: left;
    }

    #events {
        float: left;
        width: 435px;
        margin: 10px 20px 10px 5px;
    }

    #events .title {
        padding: 5px 0px;
        text-align: center;
        font-weight: bold;
        border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    }

    #events .subtitle {
        padding: 5px 0px;
        font-size: 14px;
        text-align: center;
        color: #888;
    }

    #events .list {
        height: 250px;
        overflow-y: auto;
        border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }

    #events .list .event-item {
        line-height: 24px;
        min-height: 24px;
        padding: 2px 5px;
        border-top: 1px solid rgba(0, 0, 0, 0.2);
    }

    #events .list .event-item .close {
        font-family: Tahoma, Geneva, sans-serif;
        font-weight: bold;
        font-size: 12px;
        color: #000;
        border-radius: 8px;
        height: 14px;
        width: 14px;
        line-height: 12px;
        text-align: center;
        float: right;
        border: 1px solid rgba(0, 0, 0, 0.5);
        padding: 0px;
        margin: 5px;
        display: block;
        overflow: hidden;
        background: #F44336;
        cursor: pointer;
    }

    #events .action {
        text-align: right;
    }

    #events .action input {
        padding: 0px 5px;
        font-size: 12px;
        margin: 10px 5px;
        border: 1px solid #999999;
        height: 28px;
        line-height: 28px;
        width: 120px;
        background: #f8f8f8;
        color: black;
        cursor: pointer;
        transition: all 0.2s;
    }

    #events .action input:hover {
        background: #eee;
        border: 1px solid #000;
        box-shadow: 0px 0px 3px rgba(0, 0, 0, 0.2);
    }

    .version {
        font-size: 12px;
        width: 800px;
        margin: 0 auto;
        text-align: right;
    }
</style>


{% endblock %}

{% block content %}

<header class="masthead" style="background-image: url('./static/img/yoga.jpg'); background-size: cover;">
</header>


<!-- Main Content-->
<section class="h-100">
    <div class="description">
        <div style="font-size: 1.4em;">Date Events</div>
        <div>Demo calendar date events using jsCalendar</div>
    </div>

    <!-- Wrapper -->
    <div id="wrapper">
        <!-- Calendar element -->
        <div id="events-calendar"></div>
        <!-- Events -->
        <div id="events"></div>
        <!-- Event Modal -->
        <div id="eventModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>요가동작과 감정을 기록하세요</h2>
                <input type="text" id="eventMemo" placeholder="예) 몸이 개운해서 기분 좋다:)">
                <button id="saveEvent">Save</button>
            </div>
        </div>
        <!-- HTML 템플릿 내에 숨겨진 데이터 -->
        <div style="display: none;">
            {% for event in events %}
            <span id="time">{{ event.time }}</span>
            <!-- 다른 이벤트 정보를 출력 -->
            {% endfor %}
        </div>
        <div style="display: none;">
            {% for event in events %}
            <div class="event-item">
                <!-- Display 'list' value -->
                List: {{ event.list }}
                <!--<br>-->
            </div>
            {% endfor %}
        </div>
        <!-- Clear -->
        <div class="clear"></div>
    </div>
    <div class="clear"></div>
</section>

{% endblock %}


{% block footer %}
<footer class="border-top">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">

                <div class="small text-center text-muted fst-italic">Copyright &copy; Fitech 2023</div>
            </div>
        </div>
    </div>
</footer>

<!-- Create the calendar -->
<script type="text/javascript">
    // Get elements
    var initialEvents = {{ events | tojson }};
    // Get elements
    var elements = {
        calendar: document.getElementById("events-calendar"),
        events: document.getElementById("events"),
        exerciseTypes: document.getElementById("exercise-types")
    };

    // Create the calendar
    elements.calendar.className = "clean-theme";
    var calendar = jsCalendar.new(elements.calendar);

    // Create events elements
    elements.title = document.createElement("div");
    elements.title.className = "title";
    elements.events.appendChild(elements.title);

    elements.title2 = document.createElement("div");
    elements.title2.className = "title2";
    elements.events.appendChild(elements.title2);

    elements.title3 = document.createElement("div");
    elements.title3.className = "title3";
    elements.events.appendChild(elements.title3);


    elements.subtitle = document.createElement("div");
    elements.subtitle.className = "subtitle";
    elements.events.appendChild(elements.subtitle);

    elements.list = document.createElement("div");
    elements.list.className = "list";
    elements.events.appendChild(elements.list);

    elements.actions = document.createElement("div");
    elements.actions.className = "action";
    elements.events.appendChild(elements.actions);

    elements.addButton = document.createElement("input");
    elements.addButton.type = "button";
    elements.addButton.value = "Add";
    elements.actions.appendChild(elements.addButton);

    var events = {};
    var date_format = "DD/MM/YYYY";
    var current = null;
    initialEvents.forEach(function (event) {
        var eventDateStr = jsCalendar.tools.dateToString(new Date(event.date), date_format, "en");
        if (!events.hasOwnProperty(eventDateStr)) {
            events[eventDateStr] = [];
        }
        events[eventDateStr].push({
            id: event.id,
            time: event.time,  // Include time
            list: event.list,  // Include exercise type
            memo: event.memo
        });
        calendar.select(new Date(event.date));
    });

    var showEvents = function (date) {
    var id = jsCalendar.tools.dateToString(date, date_format, "en");
    current = new Date(date.getTime());
    elements.title.textContent = id;
    elements.list.innerHTML = "";
    elements.title2.textContent = ""; // 초기화
    elements.title3.textContent = ""; // 초기화

    if (events.hasOwnProperty(id) && events[id].length) {
        elements.subtitle.textContent = events[id].length + " events";

        // 운동 시간과 종류를 분리하여 저장
        var times = [];
        var lists = [];

        events[id].forEach(function (event, index) {
            // 운동 시간과 종류가 있는 경우만 배열에 추가
            if (event.time) {
                times.push(event.time);
            }
            if (event.list) {
                lists.push(event.list);
            }

            // 이벤트 목록 표시
            var div = document.createElement("div");
            div.className = "event-item";
            div.textContent = event.memo; // 메모 표시
            elements.list.appendChild(div);

            // 삭제 버튼 추가 및 이벤트 처리
            var close = document.createElement("div");
            close.className = "close";
            close.textContent = "×";
            div.appendChild(close);
            close.addEventListener("click", function () {
                removeEvent(id, index);
            });
        });

        // 운동 시간과 종류가 존재하는 경우에만 표시
        if (times.length > 0) {
            elements.title2.textContent = "운동 시간: " + times.join(", ") + "분";
        }
        if (lists.length > 0) {
            elements.title3.textContent = "운동 종류: " + lists.join(", ");
        }
    } else {
        elements.subtitle.textContent = "No events";
    }
};

    var removeEvent = function (date, index) {
        // Date string
        var id = jsCalendar.tools.dateToString(date, date_format, "en");

        // If no events return
        if (!events.hasOwnProperty(id)) {
            return;
        }
        // If not found
        if (events[id].length <= index) {
            return;
        }

        // Remove event
        events[id].splice(index, 1);

        // Refresh events
        showEvents(current);

        // If no events uncheck date
        if (events[id].length === 0) {
            calendar.unselect(date);
        }
    }

    // Show current date events
    showEvents(new Date());

    // Add events
    calendar.onDateClick(function (event, date) {
        // Update calendar date
        calendar.set(date);
        // Show events
        showEvents(date);
    });


    // Modal related code
    var modal = document.getElementById("eventModal");
    // Ensure that we're selecting the close button inside the modal
    var closeModal = modal.getElementsByClassName("close")[0];
    var saveEventButton = document.getElementById("saveEvent");

    elements.addButton.onclick = function () {
        modal.style.display = "block";
    }

    closeModal.onclick = function () {
        modal.style.display = "none";
    }

    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    saveEventButton.onclick = function () {
        var memo = document.getElementById("eventMemo").value;
        if (memo) {
            var dateStr = jsCalendar.tools.dateToString(current, 'YYYY-MM-DD', 'en');
            addEventToCalendar(memo, dateStr);
            modal.style.display = "none";
        }
    }
    elements.addButton.addEventListener("click", function () {
        // Get event name
        if (memo) {
            var date = jsCalendar.tools.dateToString(current, 'YYYY-MM-DD', 'en');
            addEventToCalendar(memo, date);
        }

        //Return on cancel
        if (memo === null || memo === "") {
            return;
        }

        // Date string
        var id = jsCalendar.tools.dateToString(current, date_format, "en");

        // If no events, create list
        if (!events.hasOwnProperty(id)) {
            // Create list
            events[id] = [];
        }

        // If where were no events
        if (events[id].length === 0) {
            // Select date
            calendar.select(current);
        }

        // Add event
        events[id].push({ memo: memo });

        // Refresh events
        showEvents(current);
    }, false);
</script>
<script>
    function addEventToCalendar(memo, date) {
        const requestData = {
            date: date,
            memo: memo
        };

        fetch('/add_event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Event added successfully');

                    // Refresh the page to show the updated events
                    window.location.reload();
                } else {
                    alert('Error adding event: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
    }




</script>


<!-- Core theme JS-->
{% endblock %}