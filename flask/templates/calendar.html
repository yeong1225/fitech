{% extends 'base.html' %}

{% block head %}
<!--ìº˜ë¦°ë”4, test,test-->
<link href="./static/css/styles3.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<style>
    @font-face {
        font-family: 'SUITE-Regular';
        src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2304-2@1.0/SUITE-Regular.woff2') format('woff2');
        font-weight: 400;
        font-style: normal;
    }

    @font-face {
        font-family: 'komika_axisregular';
        src: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/212141/komikax_-webfont.woff2') format('woff2'), url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/212141/komikax_-webfont.woff') format('woff');
        font-weight: normal;
        font-style: normal;
    }

    html,
    body {
        font-family: "Century Gothic", CenturyGothic, AppleGothic, sans-serif;
    }

    /* ìŠ¤íƒ€ì¼ì„ ì¶”ê°€í•˜ì—¬ ë‹¬ë ¥ì„ ê¾¸ë¯¸ì„¸ìš” */
    .calendar-container {
        display: flex;
        align-items: flex-start;
    }

    /*ë°°ê²½ íšŒìƒ‰*/
    body {
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
    }

    #calendar,
    #event-display {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        overflow: hidden;

    }

    /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
    #calendar {
        margin-left: 250px;
        width: 60%;
        max-width: 400px;
        margin-right: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        /*background-color: #f5f5f5;*/
        box-sizing: border-box;
        /*box-shadow: 0px 0px 2px rgba(0, 0, 0, 0.4);*/
        margin-bottom: 10px;
        height: 420px;
    }

    .header {
        font-family: 'komika_axisregular', sans-serif;
        margin-bottom: 15px;
        text-align: center;
        /* Center align the text */
        /* Make the text bold */
        font-size: 24px;
        /* Optionally, increase the font size */
        /* Other styling properties like padding, background-color, etc., can be added here */
    }

    .calendar-table {
        width: 100%;
        border-collapse: separate;
        /* Change to 'separate' to allow border-radius */
        border-spacing: 0;
        /* Remove space between cells */
        /*border-radius: 10px;  Rounded corners for the table */
        table-layout: fixed;
        /* Keep the existing layout */
    }


    .calendar-table th,
    .calendar-table td {
        text-align: center;
        padding: 10px;
        /*border: 1px solid #ccc;*/
        border: none;
    }

    .calendar-table td {
        text-align: center;
        padding: 10px;
        /*border: 1px solid #ccc;*/
        border: none;
        overflow: hidden;
        /* ì…€ ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìˆ¨ê¹€ ì²˜ë¦¬ */
        white-space: nowrap;
        /* ë‚´ìš©ì„ í•œ ì¤„ë¡œ ì²˜ë¦¬ */
        cursor: pointer;
    }


    .other-month {
        color: #aaa;
    }

    .selected {
        background-color: #2E8B57;

        color: white;

        border-radius: 50%;
    }

    /* ì´ë²¤íŠ¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    #event-display {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #fff;
        box-sizing: border-box;
        margin-right: 250px;
        font-family: 'SUITE-Regular', Arial, sans-serif;
        height: 420px;
    }

    #selected-date {
        font-weight: bold;
        margin-bottom: 10px;
    }

    /* ì´ë²¤íŠ¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    #event-display {
        width: 35%;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #fff;
    }

    #event-display h2 {
        /* Add left margin to the "ê¸°ë¡" section */
        margin-top: 10px;
        text-align: center;
    }

    #selected-date {
        /* Add left margin to the date display */
        margin-left: 10px;
    }


    .event-details {
        margin-top: 10px;
    }

    .event-item {
        margin-bottom: 10px;
        padding: 5px;
        border: none;
        /*border: 1px solid #ccc;*/
        /*background-color: #f5f5f5;*/
    }

    /* ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #prev,
    #next {
        margin-top: 10px;
        padding: 5px 10px;
        background-color: #2E8B57;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 10px;
        margin-bottom: 30px;

    }

    #prev {
        margin-left: 250px;
    }

    /* ì´ì „/ë‹¤ìŒ ë²„íŠ¼ í˜¸ë²„ ìŠ¤íƒ€ì¼ */
    #prev:hover,
    #next:hover {
        background-color: #207244;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header-->
<header class="masthead" style="background-image: url('./static/img/yoga.jpg'); background-size: cover;">
</header>
<!-- Main Content-->
<div class="calendar-container">
    <div id="calendar"></div>
    <div id="event-display">
        <h2 style="font-family: 'SUITE-Regular', Arial, sans-serif;">Record</h2>
        <div id="event-details"></div>
    </div>
</div>
<div class="calendar-buttons">
    <button id="prev">Previous</button>
    <button id="next">Next</button>
</div>
<script>
    // ì´ˆê¸° ì„¤ì •
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let eventDetails = {};

    // ë‹¬ë ¥ ìƒì„± í•¨ìˆ˜
    function createCalendar(year, month) {
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = ''; // ë‹¬ë ¥ ì´ˆê¸°í™”

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        // ë‹¬ë ¥ì˜ í—¤ë”ë¥¼ ìƒì„± (ì›”ê³¼ ì—°ë„)
        const header = document.createElement('div');
        header.classList.add('header');
        header.textContent = `${monthNames[month]} ${year}`;
        calendar.appendChild(header);

        // ë‚ ì§œ í‘œì‹œ í…Œì´ë¸” ìƒì„±
        const table = document.createElement('table');
        table.classList.add('calendar-table');

        // ìš”ì¼ í‘œì‹œ
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const weekdayRow = document.createElement('tr');
        weekdays.forEach(weekday => {
            const dayCell = document.createElement('th');
            dayCell.textContent = weekday;
            weekdayRow.appendChild(dayCell);
        });
        table.appendChild(weekdayRow);

        // í•´ë‹¹ ì›”ì˜ ì²« ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚ ì„ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ìƒì„±
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        let currentDate = new Date(year, month, 1);
        const startDayOfWeek = firstDayOfMonth.getDay(); // ì›”ì˜ ì²« ë‚ ì˜ ìš”ì¼ ì¸ë±ìŠ¤

        // ì²« ì£¼ì— ëŒ€í•œ ìƒˆë¡œìš´ í–‰ì„ ë¨¼ì € ì¶”ê°€
        let newRow = document.createElement('tr');
        table.appendChild(newRow);

        // ì²« ì£¼ì˜ ì‹œì‘ì´ ì¼ìš”ì¼ì´ ì•„ë‹ ê²½ìš°, ë¹ˆ ì…€ë¡œ ì±„ì›ë‹ˆë‹¤.
        for (let i = 0; i < startDayOfWeek; i++) {
            let emptyCell = document.createElement('td');
            newRow.appendChild(emptyCell);
        }

        // í˜„ì¬ ì›”ì˜ ë‚ ì§œë¥¼ ì¶”ê°€í•˜ë©´ì„œ ë‹¬ë ¥ì„ ì±„ì›ë‹ˆë‹¤.
        while (currentDate <= lastDayOfMonth) {
            if (currentDate.getDay() === 0) {
                // ìƒˆë¡œìš´ ì£¼ë¥¼ ì‹œì‘í•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ í–‰ ì¶”ê°€
                newRow = document.createElement('tr');
                table.appendChild(newRow);
            }

            // ë‚ ì§œ ì…€ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
            let dateCell = document.createElement('td');
            dateCell.textContent = currentDate.getDate();
            dateCell.dataset.date = currentDate.toISOString().split('T')[0]; // data-date ì†ì„± ì¶”ê°€
            // ... ë‚ ì§œ ì…€ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì™€ ê¸°íƒ€ ì†ì„± ì¶”ê°€ ...
            newRow.appendChild(dateCell);

            currentDate.setDate(currentDate.getDate() + 1);
        }

        calendar.appendChild(table);
    }

    document.getElementById('calendar').addEventListener('click', function (event) {
        // ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ìš”ì†Œì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ 'td' ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        const targetCell = event.target.closest('td');

        // 'td' ìš”ì†Œê°€ ìˆê³ , í•´ë‹¹ ìš”ì†Œì— data-date ì†ì„±ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        if (targetCell && targetCell.dataset.date) {
            const clickedDate = targetCell.dataset.date;

            // í´ë¦­ëœ ë‚ ì§œë¥¼ Date ê°ì²´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
            const clickedDateObj = new Date(clickedDate);

            // í´ë¦­ëœ ë‚ ì§œì— 1ì¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
            clickedDateObj.setDate(clickedDateObj.getDate() + 1);

            // ì´ì „ì— ì„ íƒëœ ë‚ ì§œì˜ 'selected' í´ë˜ìŠ¤ ì œê±°
            const previouslySelected = calendar.querySelector('.selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected');
            }

            // í´ë¦­ëœ ì…€ì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
            targetCell.classList.add('selected');

            // í´ë¦­ëœ ë‚ ì§œì— 1ì¼ì„ ì¶”ê°€í•œ ë‚ ì§œë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
            const updatedDate = clickedDateObj.toISOString().split('T')[0];

            console.log(updatedDate);

            // ì´ë²¤íŠ¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” AJAX ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
            fetch(`/get_event?selected_date=${updatedDate}`)
                .then(response => response.json())
                .then(data => {
                    // ì´ë²¤íŠ¸ ì„¸ë¶€ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                    displayEventDetails(updatedDate, data);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                });
        }
    });


    // ì´ì „ ì›” ë²„íŠ¼ í´ë¦­ ì‹œ
    document.getElementById('prev').addEventListener('click', function () {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        createCalendar(currentYear, currentMonth);
    });

    // ë‹¤ìŒ ì›” ë²„íŠ¼ í´ë¦­ ì‹œ
    document.getElementById('next').addEventListener('click', function () {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        createCalendar(currentYear, currentMonth);
    });
    document.addEventListener("DOMContentLoaded", function () {

        function getYesterdayFormatted() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1); // Subtract one day
            return yesterday.toISOString().split('T')[0];
        }

        function highlightTodayAndFetchEvents() {
            const today = new Date();
            const todayFormatted = today.toISOString().split('T')[0];
            const todayFormatted2 = getYesterdayFormatted();

            // Highlight today's date in the calendar
            const todayCell = document.querySelector(`td[data-date='${todayFormatted2}']`);
            if (todayCell) {
                todayCell.classList.add('selected');
            }

            // Fetch and display event details for today
            fetchAndDisplayEventDetails2(todayFormatted);
        }

        // Function to fetch and display event details for a given date
        function fetchAndDisplayEventDetails2(date) {
            fetch(`/get_event?selected_date=${date}`)
                .then(response => response.json())
                .then(data => {
                    displayEventDetails2(date, data);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                });
        }

        // Initialize calendar and set default date to today
        createCalendar(currentYear, currentMonth);
        highlightTodayAndFetchEvents();
    });


    // function displayEventDetails(date, events) {
    //     const eventDetailsContainer = document.getElementById('event-details');
    //     eventDetailsContainer.textContent = ''; // ì´ì „ ë‚´ìš© ì´ˆê¸°í™”
    //     // Emotion to emoji mapping
    //     const emotionMap = {
    //         'excited': 'ğŸ˜†',
    //         'happy': 'ğŸ˜Š',
    //         'soso': 'ğŸ˜',
    //         'angry': 'ğŸ˜ ',
    //         'sad': 'ğŸ˜¢'
    //     };
    //     /// ì„ íƒí•œ ë‚ ì§œë¥¼ ì´ë²¤íŠ¸ ì°½ì— í‘œì‹œí•©ë‹ˆë‹¤.
    //     const selectedDateElement = document.createElement('p');
    //     selectedDateElement.id = 'selected-date';

    //     // í˜„ì¬ ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
    //     const selectedDate = new Date(date);

    //     // ë‚ ì§œë¥¼ 1ì¼ ë”í•˜ê³  ë‹¤ì‹œ ë¬¸ìì—´ë¡œ ë³€í™˜
    //     selectedDate.setDate(selectedDate.getDate());
    //     const formattedDate = selectedDate.toISOString().split('T')[0];

    //     //selectedDateElement.textContent = 'Selected Date: ' + formattedDate;
    //     selectedDateElement.textContent = 'ë‚ ì§œ : ' + formattedDate;
    //     eventDetailsContainer.appendChild(selectedDateElement);

    //     if (events && events.length > 0) {
    //         events.forEach(event => {
    //             const eventElement = document.createElement('div');
    //             eventElement.classList.add('event-item');
    //             let eventText = ''; // ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”

    //             // Check if the memo contains an emotion keyword
    //             let memoParts = event.memo.split(' ');
    //             let emotionText = memoParts.shift(); // Remove the first part of the memo
    //             let emotionEmoji = emotionMap[emotionText.toLowerCase()]; // Find corresponding emoji
    //             // If an emoji is found, prepend it to the memo
    //             let displayText = emotionEmoji ? emotionEmoji + ' ' : '';
    //             displayText += memoParts.join(' '); // Add the rest of the memo

    //             if (event.time || event.time === 0) {
    //                 // timeì´ ì¡´ì¬í•˜ë©´ ì‹œê°„ ì •ë³´ë¥¼ ì¶”ê°€
    //                 eventText += `${event.time}ë¶„<br>`;

    //             }

    //             if (event.memo) {
    //                 // memoê°€ ì¡´ì¬í•˜ë©´ ë©”ëª¨ ì •ë³´ë¥¼ ì¶”ê°€
    //                 if (eventText) {
    //                     // ì´ë¯¸ ì‹œê°„ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°, ì‹œê°„ê³¼ ë©”ëª¨ë¥¼ ì¤„ ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„
    //                     eventText += '\n';
    //                 }
    //                 eventText += displayText;
    //             }

    //             // ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ë¥¼ ì„¤ì •
    //             eventElement.innerHTML = eventText;
    //             eventElement.style.marginLeft = '5px';
    //             eventDetailsContainer.appendChild(eventElement);
    //         });
    //     } else {
    //         const noEventsMessage = document.createElement('p');
    //         noEventsMessage.textContent = 'No events for this date.';
    //         eventDetailsContainer.appendChild(noEventsMessage);
    //     }
    // }

    function displayEventDetails2(date, events) {
        const eventDetailsContainer = document.getElementById('event-details');
        eventDetailsContainer.textContent = ''; // ì´ì „ ë‚´ìš© ì´ˆê¸°í™”
        // Emotion to emoji mapping
        const emotionMap = {
            'excited': 'ğŸ˜†',
            'happy': 'ğŸ˜Š',
            'soso': 'ğŸ˜',
            'angry': 'ğŸ˜ ',
            'sad': 'ğŸ˜¢'
        };
        /// ì„ íƒí•œ ë‚ ì§œë¥¼ ì´ë²¤íŠ¸ ì°½ì— í‘œì‹œí•©ë‹ˆë‹¤.
        const selectedDateElement = document.createElement('p');
        selectedDateElement.id = 'selected-date';

        // í˜„ì¬ ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
        const selectedDate = new Date(date);

        // ë‚ ì§œë¥¼ 1ì¼ ë”í•˜ê³  ë‹¤ì‹œ ë¬¸ìì—´ë¡œ ë³€í™˜
        selectedDate.setDate(selectedDate.getDate());
        const formattedDate = selectedDate.toISOString().split('T')[0];

        //selectedDateElement.textContent = 'Selected Date: ' + formattedDate;
        selectedDateElement.textContent = 'ë‚ ì§œ : ' + formattedDate;
        eventDetailsContainer.appendChild(selectedDateElement);

        if (events && events.length > 0) {
            events.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.classList.add('event-item');
                let eventText = ''; // ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”

                // Check if the memo contains an emotion keyword
                let memoParts = event.memo.split(' ');
                let emotionText = memoParts.shift(); // Remove the first part of the memo
                let emotionEmoji = emotionMap[emotionText.toLowerCase()]; // Find corresponding emoji
                // If an emoji is found, prepend it to the memo
                let displayText = emotionEmoji ? emotionEmoji + ' ' : '';
                displayText += memoParts.join(' '); // Add the rest of the memo

                if (event.time || event.time === 0) {
                    // timeì´ ì¡´ì¬í•˜ë©´ ì‹œê°„ ì •ë³´ë¥¼ ì¶”ê°€
                    eventText += `${event.time}ë¶„<br>`;

                }

                if (event.memo) {
                    // memoê°€ ì¡´ì¬í•˜ë©´ ë©”ëª¨ ì •ë³´ë¥¼ ì¶”ê°€
                    if (eventText) {
                        // ì´ë¯¸ ì‹œê°„ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°, ì‹œê°„ê³¼ ë©”ëª¨ë¥¼ ì¤„ ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„
                        eventText += '\n';
                    }
                    eventText += displayText;
                }

                // ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ë¥¼ ì„¤ì •
                eventElement.innerHTML = eventText;
                eventElement.style.marginLeft = '5px';
                eventDetailsContainer.appendChild(eventElement);
            });
        } else {
            const noEventsMessage = document.createElement('p');
            noEventsMessage.textContent = 'No events for this date.';
            eventDetailsContainer.appendChild(noEventsMessage);
        }
    }

    // ì´ˆê¸° ë‹¬ë ¥ ìƒì„±
    createCalendar(currentYear, currentMonth);



</script>


{% endblock %}


{% block footer %}
<!-- Footer-->
<footer class="border-top">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <div class="small text-center text-muted fst-italic">Copyright Â© Fitech 2023</div>
            </div>
        </div>
    </div>
</footer>
<script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
{% endblock %}