{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" type="text/css" href="./static/css/jsCalendar.css">
<link rel="stylesheet" type="text/css" href="./static/css/jsCalendar.micro.css">
<script type="text/javascript" src="./static/js/jsCalendar.js"></script>
<script type="text/javascript" src="./static/js/jsCalendar.datepicker.js"></script>
<link href="./static/css/styles3.css" rel="stylesheet" />

<style>
    html,
    body {
        font-family: "Century Gothic", CenturyGothic, AppleGothic, sans-serif;
    }

    .description {
        text-align: center;
        padding-bottom: 40px;
    }

    .jsCalendar.clean-theme tbody td.jsCalendar-previous,
    .jsCalendar.clean-theme tbody td.jsCalendar-next {
        color: #000;
        opacity: 0.2;
    }

    #wrapper {
        margin: 0 auto;
        width: 800px;
        box-shadow: 0px 0px 2px rgba(0, 0, 0, 0.4);
    }

    #wrapper .jsCalendar table {
        box-shadow: none;
    }

    .clear {
        clear: both;
    }

    #events-calendar {
        float: left;
    }

    #events {
        float: left;
        width: 435px;
        margin: 10px 20px 10px 5px;
    }

    #events .title {
        padding: 5px 0px;
        text-align: center;
        font-weight: bold;
        border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    }

    #events .subtitle {
        padding: 5px 0px;
        font-size: 14px;
        text-align: center;
        color: #888;
    }

    #events .list {
        height: 250px;
        overflow-y: auto;
        border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }

    #events .list .event-item {
        line-height: 24px;
        min-height: 24px;
        padding: 2px 5px;
        border-top: 1px solid rgba(0, 0, 0, 0.2);
    }

    #events .list .event-item .close {
        font-family: Tahoma, Geneva, sans-serif;
        font-weight: bold;
        font-size: 12px;
        color: #000;
        border-radius: 8px;
        height: 14px;
        width: 14px;
        line-height: 12px;
        text-align: center;
        float: right;
        border: 1px solid rgba(0, 0, 0, 0.5);
        padding: 0px;
        margin: 5px;
        display: block;
        overflow: hidden;
        background: #F44336;
        cursor: pointer;
    }

    #events .action {
        text-align: right;
    }

    #events .action input {
        padding: 0px 5px;
        font-size: 12px;
        margin: 10px 5px;
        border: 1px solid #999999;
        height: 28px;
        line-height: 28px;
        width: 120px;
        background: #f8f8f8;
        color: black;
        cursor: pointer;
        transition: all 0.2s;
    }

    #events .action input:hover {
        background: #eee;
        border: 1px solid #000;
        box-shadow: 0px 0px 3px rgba(0, 0, 0, 0.2);
    }

    .version {
        font-size: 12px;
        width: 800px;
        margin: 0 auto;
        text-align: right;
    }
</style>


{% endblock %}

{% block content %}

<header class="masthead" style="background-image: url('./static/img/yoga.jpg'); background-size: cover;">
</header>


<!-- Main Content-->
<section class="h-100">
    <div class="description">
        <div style="font-size: 1.4em;">Date Events</div>
        <div>Demo calendar date events using jsCalendar</div>
    </div>

    <!-- Wrapper -->
    <div id="wrapper">
        <!-- Calendar element -->
        <div id="events-calendar"></div>
        <!-- Events -->
        <div id="events"></div>
        <!-- Clear -->
        <div class="clear"></div>
    </div>
    <div class="clear"></div>
</section>

{% endblock %}


{% block footer %}
<footer class="border-top">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">

                <div class="small text-center text-muted fst-italic">Copyright &copy; Fitech 2023</div>
            </div>
        </div>
    </div>
</footer>

<!-- Create the calendar -->
<script type="text/javascript">
    var initialEvents = {{ events | tojson }};

    // Get elements
    var elements = {
        calendar: document.getElementById("events-calendar"),
        events: document.getElementById("events")
    };

    // Initialize the calendar
    elements.calendar.className = "clean-theme";
    var calendar = jsCalendar.new(elements.calendar);
    // Create events elements
    elements.title = document.createElement("div");
    elements.title.className = "title";
    elements.events.appendChild(elements.title);
    elements.subtitle = document.createElement("div");
    elements.subtitle.className = "subtitle";
    elements.events.appendChild(elements.subtitle);
    elements.list = document.createElement("div");
    elements.list.className = "list";
    elements.events.appendChild(elements.list);
    elements.actions = document.createElement("div");
    elements.actions.className = "action";
    elements.events.appendChild(elements.actions);
    elements.addButton = document.createElement("input");
    elements.addButton.type = "button";
    elements.addButton.value = "Add";
    elements.actions.appendChild(elements.addButton);

    var events = {};
    var date_format = "DD/MM/YYYY";
    var current = null;

    // Process initial events from the database
    initialEvents.forEach(function (event) {
        var eventDateStr = jsCalendar.tools.dateToString(new Date(event.date), date_format, "en");
        if (!events.hasOwnProperty(eventDateStr)) {
            events[eventDateStr] = [];
        }
        events[eventDateStr].push({
            id: event.id,
            memo: event.memo  // 'name' is replaced with 'memo' to match database structure
        });
        calendar.select(new Date(event.date));
    });

    // Function to display events on a specific date
    var showEvents = function (date) {
        var id = jsCalendar.tools.dateToString(date, date_format, "en");
        current = new Date(date.getTime());
        elements.title.textContent = id;
        elements.list.innerHTML = "";

        if (events.hasOwnProperty(id) && events[id].length) {
            elements.subtitle.textContent = events[id].length + " events";
            events[id].forEach(function (event, index) {
                var div = document.createElement("div");
                div.className = "event-item";
                div.textContent = event.memo;
                //div.textContent = (index + 1) + ". " + event.memo;
                elements.list.appendChild(div);
                
                var close = document.createElement("div");
                close.className = "close";
                close.textContent = "×";
                div.appendChild(close);
                close.addEventListener("click", function () {
                    removeEvent(id, index);
                });
            });
        } else {
            elements.subtitle.textContent = "No events";
        }
    };

    // Function to remove an event
    var removeEvent = function (id, index) {
        if (!events.hasOwnProperty(id) || events[id].length <= index) {
            return;
        }
        events[id].splice(index, 1);
        showEvents(current);
        if (events[id].length === 0) {
            calendar.unselect(new Date(id));
        }
    };

    showEvents(new Date());

    // Add events
    calendar.onDateClick(function (event, date) {
        // Update calendar date
        calendar.set(date);
        // Add event
        events[id].push({ memo: memo });

        // Show events
        showEvents(date);
    });


    // Function to add an event to the calendar
    function addEventToCalendar(memo, dateStr) {
        var requestData = { date: dateStr, memo: memo };
        fetch('/add_event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (!events.hasOwnProperty(dateStr)) {
                        events[dateStr] = [];
                    }
                    events[dateStr].push({ memo: memo });
                    calendar.select(new Date(dateStr));
                    showEvents(current);
                } else {
                    alert('Error adding event: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
    }
</script>
<script>
    function addEventToCalendar(memo, date) {
        const requestData = {
            date: date,
            memo: memo
        };

        fetch('/add_event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Event added successfully');
                    // Reload the page or update the calendar UI as needed
                } else {
                    alert('Error adding event: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
    }


    elements.addButton.addEventListener("click", function () {
        // Get event name
        var memo = prompt("요가동작과 감정을 기록하세요", "예) 몸이 개운해서 기분 좋다:)");
        if (memo) {
            var date = jsCalendar.tools.dateToString(current, 'YYYY-MM-DD', 'en');
            addEventToCalendar(memo, date);
        }

        //Return on cancel
        if (memo === null || memo === "") {
            return;
        }

        // Date string
        var id = jsCalendar.tools.dateToString(current, date_format, "en");

        // If no events, create list
        if (!events.hasOwnProperty(id)) {
            // Create list
            events[id] = [];
        }

        // If where were no events
        if (events[id].length === 0) {
            // Select date
            calendar.select(current);
        }

        // Add event
        events[id].push({ memo: memo });

        // Refresh events
        showEvents(current);
    }, false);
    
</script>


<!-- Core theme JS-->
{% endblock %}